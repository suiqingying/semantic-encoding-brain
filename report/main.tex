% !TeX program = xelatex
% !TeX output-file = main.pdf
% 使用 ctexrep 获取原生 chapter 层级
\documentclass[UTF8,a4paper,zihao=-4,fontset=none]{ctexrep}

% ===================== 1. 基础页面设置 =====================
\usepackage[a4paper,
  top=2.8cm, bottom=2.8cm, left=2.4cm, right=2.4cm,
  headheight=25pt, marginparwidth=2cm
]{geometry}
\usepackage{setspace}
\setstretch{1.5}
\usepackage{indentfirst}
\setlength{\parindent}{2em}
\usepackage{microtype}
\usepackage{enumitem}
\setlist{nosep}
\usepackage{tabularx}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{booktabs}
\usepackage{longtable}
\usepackage{float}

% ===================== 2. 字体设置 =====================
\usepackage{fontspec}
\setmainfont{Times New Roman}
\setsansfont{Times New Roman}
\setmonofont{JetBrains Mono}
% 使用宋体并启用假粗体以消除缺失粗体警告
\setCJKmainfont{SimSun}[BoldFont=SimSun,AutoFakeBold=2]
\setCJKsansfont{SimSun}[BoldFont=SimSun,AutoFakeBold=2]
\setCJKmonofont{SimSun}[AutoFakeBold=2]
\newCJKfontfamily{\TitleCJK}{SimSun}[BoldFont=SimSun,AutoFakeBold=2]

% ===================== 3. Nord极光配色方案 =====================
\usepackage{xcolor}

% Nord Polar Night (深色背景系)
\definecolor{Nord0}{HTML}{2E3440}   % 最深，用于强调文字
\definecolor{Nord1}{HTML}{3B4252}   % 深灰
\definecolor{Nord2}{HTML}{434C5E}   % 中灰
\definecolor{Nord3}{HTML}{4C566A}   % 浅灰

% Nord Snow Storm (浅色背景系)
\definecolor{Nord4}{HTML}{D8DEE9}   % 浅灰背景
\definecolor{Nord5}{HTML}{E5E9F0}   % 更浅
\definecolor{Nord6}{HTML}{ECEFF4}   % 最浅，接近白色

% Nord Frost (冰蓝色系 - 主色调)
\definecolor{Nord7}{HTML}{8FBCBB}   % 青绿色
\definecolor{Nord8}{HTML}{88C0D0}   % 冰蓝色 - 主色
\definecolor{Nord9}{HTML}{81A1C1}   % 蓝灰色
\definecolor{Nord10}{HTML}{5E81AC}  % 深蓝色

% Nord Aurora (极光色系 - 强调色)
\definecolor{Nord11}{HTML}{BF616A}  % 红色
\definecolor{Nord12}{HTML}{D08770}  % 橙色
\definecolor{Nord13}{HTML}{EBCB8B}  % 黄色
\definecolor{Nord14}{HTML}{A3BE8C}  % 绿色
\definecolor{Nord15}{HTML}{B48EAD}  % 紫色

% 语义化别名
\definecolor{BrandColor}{HTML}{5E81AC}      % Nord10 深蓝 - 主品牌色
\definecolor{AccentColor}{HTML}{88C0D0}     % Nord8 冰蓝 - 强调色
\definecolor{DarkText}{HTML}{2E3440}        % Nord0 深色文字
\definecolor{LightGrayBG}{HTML}{ECEFF4}     % Nord6 浅色背景
\definecolor{SectionNum}{HTML}{81A1C1}      % Nord9 章节数字

\colorlet{Primary}{BrandColor}
\colorlet{Secondary}{Nord9}
\colorlet{Ink}{DarkText}

% ===================== 4. 图形与视觉组件 =====================
\usepackage{graphicx}
\usepackage{caption}
\captionsetup{font={small,sf,color=Ink!80},labelfont={bf,color=BrandColor},labelsep=quad}
% 以 report/ 为工作目录编译：图片路径相对当前 tex 文件
\graphicspath{{figures/}{figures/brainmaps/}}
\usepackage{tikz}
\usetikzlibrary{shapes, shadows, positioning, calc, backgrounds, fadings}
\usepackage{tcolorbox}
\tcbuselibrary{skins, breakable}
\usepackage{xurl}
\setlength{\emergencystretch}{2em}
\sloppy
\hbadness=10000
\vbadness=10000
\hfuzz=20pt
\vfuzz=10pt

% 摘要盒子设计：Nord极光风格
\newtcolorbox{AbstractBox}{
  enhanced,
  breakable,
  colback=Nord6,              % Nord浅色背景
  colframe=Nord8,             % 冰蓝边框
  coltitle=Nord10,            % 深蓝标题
  fonttitle=\TitleCJK\bfseries\large,
  title={摘\quad 要},
  detach title,
  before upper={\tcbtitle\par\vspace{0.5em}},
  frame hidden,
  leftrule=4pt,               % 左侧极光装饰线
  arc=2mm,
  left=15pt, right=10pt, top=12pt, bottom=12pt,
  shadow={1mm}{-1mm}{0mm}{Nord4!50}
}

% ===================== 5. 标题样式系统 =====================
\usepackage{titlesec}

% Chapter 样式
\titleformat{\chapter}
  {\TitleCJK\sffamily\bfseries\huge\color{Nord10}}
  {\makebox[0pt][l]{\hspace{-0.4em}\raisebox{1.5ex}{\color{Nord8!30}\fontsize{70}{70}\selectfont\thechapter}}}
  {0em}
  {}
  [{\vspace{-0.5ex}\color{Nord8!50}\titlerule[2pt]}]
\titlespacing*{\chapter}{0pt}{4.5ex plus 1ex minus .2ex}{2.5ex plus .2ex}

% Section 样式
\titleformat{\section}
  {\TitleCJK\sffamily\bfseries\Large\color{Nord0}}
  {}
  {0em}
  {\tikz[baseline=(current bounding box.east),outer sep=0pt]
    \fill[Nord8] (0,0) rectangle (0.6em, 1.2em);
   \hspace{0.6em}\thesection\hspace{0.8em}}
\titlespacing*{\section}{0pt}{3ex plus 1ex minus .2ex}{1.5ex plus .2ex}

% Subsection 样式
\titleformat{\subsection}
  {\TitleCJK\sffamily\large\bfseries\color{Nord9}}
  {\thesubsection}
  {1em}
  {}

% ===================== 6. 目录重构 =====================
\usepackage{titletoc}

\renewcommand{\contentsname}{\TitleCJK\bfseries\Huge 目录}

% Chapter 目录条目（只显示标题，不显示编号）
\titlecontents{chapter}[0em]
  {\addvspace{12pt}\sffamily\bfseries\large}
  {}
  {}
  {\hfill\color{Nord10}\contentspage}

% Section 目录条目
\titlecontents{section}[3.5em]
  {\addvspace{6pt}\sffamily\small}
  {\contentslabel[\color{Nord3}\thecontentslabel]{2.8em}}
  {}
  {\titlerule*[0.8pc]{.}\contentspage}

% Subsection 目录条目
\titlecontents{subsection}[6.0em]
  {\addvspace{2pt}\sffamily\footnotesize}
  {\contentslabel[\color{Nord3!80}\thecontentslabel]{3.0em}}
  {}
  {\titlerule*[0.6pc]{.}\contentspage}

% ===================== 7. 页眉页脚 =====================
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[L]{\sffamily\color{Nord3}\footnotesize \leftmark}
\fancyhead[R]{\sffamily\color{Nord3}\footnotesize \CourseName}
\fancyfoot[C]{
  \tikz\node[
    rectangle,
    fill=Nord10,
    text=white,
    rounded corners=3pt,
    inner sep=4pt,
    minimum width=2.2em
  ]{\small\thepage};
}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}

% 让 plain 页（章首页、目录页等）也使用相同的页眉页脚样式
% 章节首页使用的 plain 样式：与正文一致的页眉页脚
\fancypagestyle{plain}{%
  \fancyhf{}
  \fancyhead[L]{\sffamily\color{Nord3}\footnotesize \leftmark}
  \fancyhead[R]{\sffamily\color{Nord3}\footnotesize \CourseName}
  \fancyfoot[C]{%
    \tikz\node[
      rectangle,
      fill=Nord10,
      text=white,
      rounded corners=3pt,
      inner sep=4pt,
      minimum width=2.2em
    ]{\small\thepage};%
  }
  \renewcommand{\headrulewidth}{0pt}
  \renewcommand{\footrulewidth}{0pt}
}

% 目录页专用样式：去掉页眉，保留统一页脚
\fancypagestyle{tocplain}{%
  \fancyhf{}
  \fancyfoot[C]{%
    \tikz\node[
      rectangle,
      fill=Nord10,
      text=white,
      rounded corners=3pt,
      inner sep=4pt,
      minimum width=2.2em
    ]{\small\thepage};%
  }
  \renewcommand{\headrulewidth}{0pt}
  \renewcommand{\footrulewidth}{0pt}
}

% 强制 \tableofcontents 使用 tocplain（无页眉、统一页脚）
\makeatletter
\let\oldtableofcontents\tableofcontents
\renewcommand{\tableofcontents}{%
  \begingroup
    \let\ps@plain\ps@tocplain
    \pagestyle{tocplain}
    \oldtableofcontents
    \thispagestyle{tocplain}
  \endgroup
}
\makeatother

% ===================== 8. 链接设置 =====================
\usepackage{hyperref}

% ===================== 信息宏定义 =====================
\newcommand{\StudentName}{潘宇轩}
\newcommand{\StudentID}{2023K8009991004}
\newcommand{\Department}{人工智能学院}
\newcommand{\Major}{人工智能}
\newcommand{\CourseName}{认知神经科学}

\newcommand{\PaperTitle}{语义编码与多模态对齐：综述与实验报告}
\newcommand{\PaperSubtitle}{基于故事听觉 fMRI 的预训练模型特征比较与相关工作整合}
\newcommand{\PaperTitleEn}{Semantic encoding and multimodal alignment: a review and experimental report}

% hyperref 需要在相关宏定义之后设置，确保 \PaperTitle、\StudentName 已定义
\hypersetup{
  colorlinks=true,
  linkcolor=BrandColor,
  urlcolor=AccentColor,
  citecolor=BrandColor,
  pdfborder={0 0 0},
  pdftitle={\PaperTitle},
  pdfauthor={\StudentName}
}

% ===================== 全局图片插图命令 =====================
\newcommand{\InsertFig}[4]{%
  \begin{figure}[tbp]
    \centering
    \includegraphics[width=#2,height=0.78\textheight,keepaspectratio]{#1}%
    \caption{#3}%
    \label{#4}%
  \end{figure}%
}

% ===================== 附录：原始文件嵌入 =====================
\usepackage{fancyvrb}

\begin{document}

% ===================== 封面设计（复用综述风格） =====================
\begin{titlepage}
  \thispagestyle{empty}
  \newgeometry{margin=0cm}
  \begin{tikzpicture}[remember picture,overlay]
    % Nord 渐变背景与细网格
    \path[shade, left color=Nord10!90, right color=Nord7!85]
      (current page.north west) rectangle (current page.south east);
    \foreach \y in {0.05,0.15,...,0.95} {
      \draw[white, opacity=0.05, line width=0.5pt]
        ([yshift=\y\paperheight]current page.west) -- ([yshift=\y\paperheight]current page.east);
    }
    \foreach \x in {0.1,0.25,...,0.9} {
      \draw[white, opacity=0.06, line width=0.5pt]
        ([xshift=\x\paperwidth]current page.south) -- ([xshift=\x\paperwidth]current page.north);
    }
    % 角落极光圆斑
    \fill[Nord8!28, opacity=0.65] ([xshift=-2cm,yshift=1cm]current page.north east) circle (3.5cm);
    \fill[Nord12!24, opacity=0.55] ([xshift=2cm,yshift=-1cm]current page.south west) circle (4cm);
    \node[
      anchor=center,
      yshift=0.02\paperheight,
      rounded corners=4mm,
      fill=Nord6,
      fill opacity=0.90,
      text opacity=1,
      draw=Nord8!40,
      draw opacity=1,
      line width=0.8pt,
      inner xsep=18pt,
      inner ysep=16pt,
      drop shadow={opacity=0.18, shadow xshift=0mm, shadow yshift=-1.2mm}
    ] at (current page.center) {%
      \begin{minipage}{0.78\paperwidth}
        \centering
        \tikz\node[fill=Nord8!20, text=Nord10, rounded corners=18pt, inner sep=9pt]
          {\sffamily\bfseries\large \CourseName};\\[1.1cm]

        {\rmfamily\bfseries\fontsize{34}{46}\selectfont\color{Nord0} \PaperTitle}\\[0.35cm]
        {\TitleCJK\sffamily\Large\color{Nord0!80} \PaperSubtitle}\\[0.45cm]
        {\fontspec{TeX Gyre Pagella}\itshape\fontsize{13}{18}\selectfont\color{Nord3} \PaperTitleEn}\\[1.0cm]

        \tikz\draw[Nord13, line width=1.6pt] (0,0) -- (4.8,0);\\[1.0cm]

        \renewcommand{\arraystretch}{1.55}
        \sffamily\color{Nord0}
        \begin{tabular}{r@{\hspace{1em}}l}
          \textbf{\color{Nord9} 报告人} & \large \StudentName \\
          \textbf{\color{Nord9} 学\quad 号} & \large \StudentID \\
          \textbf{\color{Nord9} 院\quad 系} & \large \Department \\
          \textbf{\color{Nord9} 专\quad 业} & \large \Major \\
          \textbf{\color{Nord9} 日\quad 期} & \large \today \\
        \end{tabular}
      \end{minipage}%
    };
  \end{tikzpicture}
\end{titlepage}
\restoregeometry

% ===================== 摘要页（不使用列表，全文段落） =====================
\clearpage
\begin{AbstractBox}
本报告在自然故事听觉范式的 fMRI 数据上，系统比较了不同预训练模型表征与大脑反应的对齐程度。理论背景部分围绕自然语音语义地图 \cite{Huth2016,Zhang2020}、集成建模与预测加工框架 \cite{Schrimpf2021,Antonello2023,Kumar2024}、自监督语音表征与皮层层级对齐 \cite{Baevski2020,Millet2023}、上下文表征与组合语义 \cite{Peters2018,Devlin2019,Radford2019,Toneva2022} 以及连续语义重构的解码路径 \cite{Tang2023} 展开。实验部分严格基于当前仓库中已经生成的结果文件撰写，全部数值可追溯到 \texttt{results/summary.csv}、\texttt{results/roi.csv}、\texttt{results/fusion/**/log.txt} 与对应的相关图数组（单模态为 \texttt{corr\_layer*.npy}，融合为 \texttt{corr\_*.npy}）。在统一的对齐、降维（PCA）与时延展开（FIR）流程下，我们在多被试上训练线性岭回归编码模型，并以测试集相关系数刻画“可预测性”。结果表明，在当前设置下，音频与多模态模型显著优于纯文本语义表征，并且 TR 窗口长度对音频与融合性能具有决定性影响；在融合实验中，最佳文本层与最佳音频层的组合呈现非单调交互。报告同时呈现统计图与脑图两类证据：统计图由 \texttt{report/scripts/make\_figures.py} 直接从结果表生成，脑图由 \texttt{src/run\_plot\_corr\_maps.py} 将相关图映射到皮层表面生成并保存到 \texttt{report/figures/brainmaps/}。
\end{AbstractBox}
\clearpage

% ===================== 目录页（带装饰，无多余空白页） =====================
{
  \newgeometry{top=3cm, bottom=3cm, left=3cm, right=3cm}
  % 目录页背景装饰
  \begin{tikzpicture}[remember picture, overlay]
     \node[anchor=north east, text=Nord5, font=\bfseries\fontsize{120}{120}\selectfont, rotate=-90] 
       at ([xshift=-1cm, yshift=-3cm]current page.north east) {CONTENT};
     \draw[line width=2pt, Nord8!30] ([xshift=-2.5cm]current page.north east) -- ([xshift=-2.5cm]current page.south east);
  \end{tikzpicture}

  \hypersetup{linkcolor=Nord0} 
  % 避免 \tableofcontents 内部的清页指令让目录另起一整页
  \begingroup
    % 目录页使用无页眉的 tocplain 样式
    \makeatletter
    \let\ps@plain\ps@tocplain
    \makeatother
    \pagestyle{tocplain}
    \thispagestyle{tocplain}
    \let\clearpage\relax
    \let\cleardoublepage\relax
    \par\tableofcontents
  \endgroup
  \restoregeometry
}

% ===================== 正文（章节拆分在独立文件中） =====================

\chapter{背景与相关工作}
\input{experiment_chapters/01_background}

\chapter{实验设计与方法}
\input{experiment_chapters/02_data_alignment}
\input{experiment_chapters/03_models_features}
\input{experiment_chapters/04_encoding_evaluation}

\chapter{实验结果}
\input{experiment_chapters/05_text_results}
\input{experiment_chapters/06_audio_results}
\input{experiment_chapters/07_multimodal_results}
\input{experiment_chapters/08_fusion_results}

\chapter{讨论}
\input{experiment_chapters/09_roi_discussion}

\chapter{结论}
\input{experiment_chapters/10_conclusion}

\clearpage
\bibliographystyle{plain}
\bibliography{refs}

\end{document}
